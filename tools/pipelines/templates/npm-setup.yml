parameters:
  - name: 'installCypress'
    default: false
    type: boolean

  - name: 'NODE_MODULES'
    default: '**/node_modules, !**/node_modules/**/node_modules'
    type: string
steps:
  - task: Cache@2
    inputs:
      key: yarn | $(Agent.OS) | yarn.lock
      restoreKeys: |
        yarn | "$(Agent.OS)"
        yarn
      path: '**/node_modules, !**/node_modules/**/node_modules'
    displayName: Cache Yarn packages
    cacheHitVar: CACHE_RESTORED

  - task: Cache@2
    inputs:
      key: cypress | $(Agent.OS) | yarn.lock
      path: /home/vsts/.cache/Cypress
      restoreKeys: cypress | $(Agent.OS) | yarn.lock
    displayName: Cache Cypress binary
    condition: eq('${{ parameters.installCypress }}', 'true')

  # Install Node dependencies
  - script: yarn --frozen-lockfile
    condition: eq('${{ parameters.installCypress }}', 'true')
    displayName: 'Install NPM dependencies'

  - script: yarn --frozen-lockfile
    condition: and(ne(variables.CACHE_RESTORED, 'true'), eq('${{ parameters.installCypress }}', 'false'))
    displayName: 'Install NPM dependencies'
